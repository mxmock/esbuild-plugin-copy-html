var w=require("path"),P=require("node:fs/promises"),R=require("html-minifier").minify,{rm:A,writeFile:F,readFile:x,mkdir:y,readdir:H,stat:S}=P,$=process.cwd(),b=async({htmlFrom:t,jsFrom:s,cssFrom:r,outDir:e,removeAfter:o})=>{try{if(!t)throw new Error("Must indicate where html come from");await y(e,{recursive:!0});let n=`${$}/${e}`,i=await p(t),a=await j(i,t,n),c=s?await p(s):[],d=r?await p(r):[];for(let l=0;l<a.length;l++){let{path:f,content:u}=a[l];d.length&&(u=C(d,f,u)),c.length&&(u=N(c,f,u)),await M(f,u),console.log(`Html file copied at path ${f}`),console.log("-------------------------------------------"),console.log("-------------------------------------------")}o&&await U(t)}catch(n){console.error(`copyHtmlPlugin error - onEnd - ${n.message}`)}},p=async t=>{let s=await H(t,{withFileTypes:!0}),r=await Promise.all(s.map(e=>{let o=w.resolve(t,e.name);return e.isDirectory()?p(o):o}));return Array.prototype.concat(...r)},j=async(t,s,r)=>{let e=t.map(n=>new Promise((i,a)=>{x(n,"utf8").then(c=>{c||a(`Can't read file ${n}`);let d=k(n,s,r),l=R(c,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0});i({path:d,content:l})}).catch(c=>a(c))}));return await Promise.all(e)},k=(t,s,r)=>{let e=`${$}/${s}`.split("/"),n=t.split("/").filter(i=>!e.includes(i)).join("/");return`${r}/${n}`},C=(t,s,r)=>{let e=r;return e=v(e,'<link rel="stylesheet"','css">'),t.map(n=>D(n,s)).map(L).forEach(n=>{e=E(e,n)}),e},N=(t,s,r)=>{let e=r;return e=v(e,"<script","</script>"),t.map(n=>D(n,s)).map(I).forEach(n=>{e=E(e,n)}),e},v=(t,s,r)=>{let e=t;for(;e.includes(s);){let o=g(e,s),n=g(e,r);e=O(e,o[0],n[0],r.length)}return e},g=(t,s)=>[...t.matchAll(new RegExp(s,"gi"))].map(r=>r.index),O=(t,s,r,e)=>{let o=t.substring(0,s),n=t.substring(r+e);return`${o}${n}`},D=(t,s)=>{let r=m(s,t),e=q(r.length),o=m(t,s);return[e,...o].join("/")},m=(t,s)=>{let r=t.split("/"),e=s.split("/");return r.reduce((o,n,i)=>e[i]===n?[...o]:[...o,n],[])},q=t=>{let s=t-1;if(s===0)return".";let r="";for(let e=0;e<s;e++)r+="../";return r.slice(0,-1)},I=t=>`<script src="${t}"></script>`,L=t=>`<link rel="stylesheet" href="${t}">`,E=(t,s)=>{let r=t.indexOf("</head>"),e=t.substring(0,r),o=t.substring(r);return`${e}${s}${o}`},M=async(t,s)=>{let r=w.dirname(t);await T(r)||await y(r,{recursive:!0}),await F(t,s)},T=async t=>{let s=await S(t).catch(r=>{if(W(r))return!1;throw r});return s&&s.isDirectory()},U=t=>new Promise((s,r)=>{A(t,{recursive:!0,force:!0},e=>{e&&r(e),s(`${t} was deleted`)})}),W=t=>t.code==="ENOENT",h=t=>typeof t=="string"&&t.length>0;module.exports=(t={})=>{let s=h(t.htmlFromDir)?t.htmlFromDir:null,r=h(t.jsDir)?t.jsDir:null,e=h(t.cssDir)?t.cssDir:null,o=t.outDir||"out",n=!!t.removeOriginalDir;return{name:"copyHtmlPlugin",setup:i=>{i.onEnd(async a=>{await b({htmlFrom:s,jsFrom:r,cssFrom:e,outDir:o,removeAfter:n})})}}};